# Отчет о выполнении задания "Дрон - опрыскиватель" командой КИБЕРимунеле.

Состав команды:
- Липонина Екатерина Алексеевна - 3 курс ФБИТ ИТМО
- Клетенкова Алёна Дмитриевна - 3 курс ФБИТ ИТМО
- Алексеенко Арина Вячеславовна - 3 курс ФБИТ ИТМО
- Золотников Иван Константинович - 3 курс ФБИТ ИТМО

***
КИБЕРимунеле - укрепи свой КИБЕРиммунитет!
***
- [Отчёт о выполнении задачи "Дрон - опрыскиватель"](#отчёт-о-выполнении-задачи-secure-update)
  - [Постановка задачи](#постановка-задачи)
  - [Известные ограничения и вводные](#известные-ограничения-и-вводные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
  - [Архитектура системы](#архитектура-системы)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются](#описание-сценариев-последовательности-выполнения-операций-при-которых-цб-нарушаются)
    - [Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора.](#указание-доверенных-компонент-на-архитектурной-диаграмме-с-обоснованием-выбора)
    - [Политики безопасности](#политики-безопасности)
  - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

## Постановка задачи

Необходимо создать программное обеспечение (далее – ПО) для беспилотного летательного аппарата (далее – дрон), с помощью которого можно обеспечить безопасное управление через мобильное приложение или управляющий центр (далее – УЦ) и выполнение задач дроном. В задачи дрона входит распыление пестицидов или удобрений (далее – смесь) по заданному участку или сброс нужного количества смеси в конкретных координатах. 

## Известные ограничения и вводные

По условиям организаторов между собой сервисы общаются через шину сообщений (message bus), а всё снаружи принимают в виде REST запросов.

### Цели и Предположения Безопасности (ЦПБ)

В качестве целей безопасности можем выделить следующие пункты:
1. Обеспечить безопасное использование дрона, то есть не допустить распыления токсичных веществ вне рамок цели задания.
2. Обеспечить защиту непосредственно самого дрона, то есть по возможности исключить выполнение инструкций, приводящих к повреждению или разрушению дрона.
3. Обеспечить получение и выполнение инструкций только от подтвержденных пользователей.
4. Обеспечить получение и выполнение инструкций только от подтвержденного управляющего центра (далее - УЦ).

Предположения безопасности:
1. Дрон имеет защиту от атак на физическом уровне доступа.
2. Дрон имеет защиту от намеренного искажения GPS координат.
3. После получения задания дрон функционирует автономно и после выполнения задачи возвращается на базу кратчайшим маршрутом.

## Упрощения

Смесь не имеет массы и объёма. Графический интерфейс для взаимодействия с пользователем не требуется, достаточно примеров REST запросов. В рамках игры для простоты компонентам следует использовать одинаковый подход передачи сообщений и ограничиться имитатором API. Приборная точность позиционирования достаточна для выполнения полётного задания.

### Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются

**Сценарий №1**
Скомпрометирован модуль “Управление распрыскивателем”. 
1. Модуль “Контроль обстановки” подает сигнал о человеке на пути следования дрона. 2. Модуль управления распрыскивателем не отключает разбрызгиватели. 
3. Человек становится обрызган химикатами. <br>
Как итог, не выполнена ЦБ №1.

![Снимок экрана от 2022-12-03 09-36-30](https://user-images.githubusercontent.com/112805915/205430269-d425bd8b-d4ab-49b0-ac92-bd7476174477.png)

**Сценарий №2**

Скомпрометирован модуль “Управление полетом”.
1. Модуль “Контроль обстановки” подает сигнал о препятствии (дереве) на пути следования дрона.
2. Модуль “Управление полетом” не меняет курс движения дрона.
3. Дрон врезается в дерево и получает повреждения.<br>
Как итог, не выполнена ЦБ №2.

![Снимок экрана от 2022-12-03 09-34-41](https://user-images.githubusercontent.com/112805915/205430363-e3f09a0e-0d1b-4b4f-ab86-70770fc1f59a.png)

**Сценарий №3**

Использование недоверенного сервера.
1. Запуск приложения
2. Авторизация пользователя пройдена
3. Отправлена команда с МП на получение задания
4. Дрон подключается к "подменному" серверу УЦ
5. Выполнение дроном неверных инструкций <br>
Как итог, не выполнена ЦБ №4

![Снимок экрана от 2022-12-03 09-42-33](https://user-images.githubusercontent.com/112805915/205430347-cd556fa0-6666-46e2-9cef-e3a4c8bce976.png)

Сценарий №4
Скомпрометировано мобильное приложение.
1. Злоумышленник получает доступ к МП.
2. Злоумышленник получает контроль над дроном.
3. Злоумышленник дает дрону команду на аварийное завершение.<br>
Как итог, не выполнена ЦБ №3

![Снимок экрана от 2022-12-03 10-42-04](https://user-images.githubusercontent.com/112805915/205430579-cfc1df14-2272-4408-981d-2bbd07f22994.png)

| № | Название | Скомпроментированная часть | Нарушенная цель безопасности |
|----|----|----|----|
|*1* | Смесь распылена на человека | Дрон (Управление распрыскивателем) | 1 | |
|*2* | Столкновение с деревом | Дрон (Управление полетом) | 2 | |
|*3* | Получение неверной команды | . | 4 | |
|*4* | Неавторизованный доступ к дрону | МП | 3 | |

### Описание позитивных сценариев работы

**Сценарий №1**

1. Включение дрона
2. Инициализация управления полетом
3. Получение полетного задания
4. Сообщение о начале полета
5. Достижение района выполнения работ
6. Активация управления распрыскивателем
7. Выполнение полетного задания
8. Выключение распрыскивателя
9. Сообщение о завершении работ
10. Возвращение на базу
11. Отчет о выполнении полетного задания

**Сценарий №2**

1. Включение дрона
2. Получение полетного задания
3. Сбой в получении полетного задания
4. Отправка сообщения об ошибке полетного задания в УЦ
5. Ожидание следующего полетного задания

**Сценарий №3**

1. Дрон физически неисправен или не укомплектован (на любом из этапом работы)
2. Посылает сообщения о неисправности
3. Сообщения о неисправности обрабатываются УЦ
4. Дрон аварийно завершает работу и возвращается на базу

**Сценарий №4**

1. Отправляется команда с приложения
2. Дрон ее **не** выполняет
3. Приложение не получает уведомления о начале выполнения команды
4. Отправляется команда с приложения
5. Дрон ее **не** выполняет
6. Дрон аварийно завершает работу и возвращается на базу

**Сценарий №5**

1. Дрон отправил сообщение об ошибке
2. Получение сообщения об ошибке в МП
3. Произошло реагирование на ошибку
4. Получена команда экстренного завершения
5. Дрон аварийно завершает работу и возвращается на базу

### Политики безопасности

```python {lineNo:true}
def check_operation(id, details):
    authorized = False
    src = details['source']
    dst = details['deliver_to']
    operation = details['operation']
    if  src == 'gps-position' and dst == 'situation-control' \
        and operation == 'current-position':
        authorized = True   
    if src == ‘gps-position’ and dst == 'flight-control' \
        and operation == 'position-response':
        authorized = True   
    if src == 'situation-control' and dst == 'flight-control' \
        and operation == 'position-change':
        authorized = True   
    if src == 'mobile-app' and dst == 'state-control' \
        and operation == 'state-request':
        authorized = True   
    if src == 'state-control and dst == ‘mobile-app' \
        and operation == 'state-response':
        authorized = True   
    if src == 'mobile-app' and dst == 'control-center' \
        and operation == 'report-response':
        authorized = True   
    if src == 'control-center' and dst == 'mobile-app' \
        and operation == 'report-request':
        authorized = True   
    if src == 'flight-control' and dst == 'mobile-app' \
        and operation == 'start-job-report':
        authorized = True
    if src == 'flight-control' and dst == 'mobile-app' \
        and operation == 'end-job-report':
        authorized = True
    if src == 'flight-control' and dst == 'control-center' \
        and operation == 'flight-job-report':
        authorized = True   
    if src == 'flight-control' and dst == 'control-center' \
        and operation == 'task-request':
        authorized = True   
    if src == 'control-center' and dst == 'flight-control' \
        and operation == 'task-response':
        authorized = True   
    if src == 'flight-control' and dst == 'sprayer-control' \
        and operation == 'switch-mode':
        authorized = True   
    if src == 'situation-control' and dst == 'sprayer-control' \
        and operation == 'switch-mode':
        authorized = True   
    if src == 'flight-control' and dst == 'situation-control' \
        and operation == 'activate-yourself':
        authorized = True   
    if src == 'flight-control' and dst == 'gps-position' \
        and operation == 'position-request':
        authorized = True   
     
    return authorized

```
## Архитектура системы

### Компоненты

| Название | Назначение | Комментарий |
|----|----|----|
|*Управляющий центр* | Удалённый сервер, распределяющий полётные задания для дронов и следящий за их выполнением. | Доверенный |
|*Мобильное приложение дрона* | Приложение для управления дроном, отслеживания и проверки состояния дрона. | |
|*GPS позиционирование* | Определяет координаты дрона в любой момент времени. | |
|*Связь с мобильным приложением* | Отвечает за передачу команд от МП к Управлению полетом. | |
|*Связь с управляющим центром* | Отвечает за передачу команд от УЦ к Управлению полетом. | |
|*Контроль обстановки*  | Следит за окружающей дрона средой во избежание столкновений и ошибок распрыскивания. | Доверенный |
|*Управление полётом* | Следит за выполнением полётного задания, отвечает за непосредственное движение дрона в пространстве. | |
|*Контроль состояния дрона* | Проверяет состояние всех модулей дрона во избежание аварийных ситуаций, а также состояния распрыскивателей. | Доверенный|
|*Управление распрыскивателем* | Следит за количеством расходования смеси и отвечает за распыление включение и отключение распрыскивателя. | |
|*Security monitor*<br>(монитор безопасности) | Авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае. Также отвечает за "контроль после проишествия" - анализирует, нет ли модулей с некорректным поведением.| Доверенный |
|*Message bus* | Шина сообщений и брокер - сервис передачи сообщений от источника получателям. | kafka, доверенный |
|*Аварийное возвращение* | Экстренный модуль, принимающий управление дроном, если монитор безопасности посчитал его (дрон) скомпроментированным. | Доверенный |

<img width="1263" alt="A4 - 1(3)" src="https://user-images.githubusercontent.com/89799277/205373202-a7e155bb-1f80-489b-832c-86006a1f62e9.png">

### Общая схема взаимодействия
<img width="2382" alt="Hackaton" src="https://user-images.githubusercontent.com/89799277/205433698-6585cf0f-49db-4e55-b8c0-50ad5bab2566.png">

### Указание "доверенных компонент" на архитектурной диаграмме

<img width="1263" alt="A4 - 2(2)" src="https://user-images.githubusercontent.com/89799277/205380798-e752e61f-0b02-4986-b31a-95ed36159370.png">

## Детальный разбор подсистем

### Управляющий центр

Создает полетные задания для дронов. Распределяет полетные маршруты и проверяет их на безопасность с точки зрения пересечения. Ведет реестр ошибок и аварийных ситуаций. Регистрирует результаты выполнения полетных заданий. Взаимодействует с дроном через API.

### Мобильное приложение

Получает информацию о состоянии дрона в течении всего периода взаимодействия/управления полетом. Передает дрону различные команды (запуск, возвращение на базу). Взаимодействует с дроном через API.

### Оператор

Взаимодействует с дроном через API. Для авторизации необходимо использовать уникальный PIN код (программная реализация механизма передачи PIN кода не требуется). Также PIN код используется при отправке данных.

### Управление полетом

Контролирует состояние дрона. Контролирует исполнение полетного задания. Отслеживает позиционирование дрона в 3D. Поддерживает связь с УЦ и мобильным приложением. В задаче использует только API.

### GPS позиционирование

Выдаёт текущие координаты (x, y, z). Отслеживает прерывание сигнала. Отслеживает ошибки позиционирования.

### Контроль обстановки

Контролирует высоту полета. Контролирует появление наземных объектов (люди, животные) в месте распрыскивания смеси. Контролирует состояние датчиков столкновения.

### Контроль состояния дрона

Контролирует уровень заряда батареи. Контролирует состояние распрыскивателя. Контролирует уровень смеси (сколько осталось). Контролирует состояние прочих модулей дрона.

### Управление распрыскивателем

Контролирует расход смеси. Отключает и включает распрыскиватель в заданных точках маршрута. Управляет аварийным выключением распрыскивателя.

### Аварийное возвращение

Модуль принимает на себя управление в случае, если монитор безопасности признает дрон скомпроментированным (см. решение пункт 1). Обладает минимальными возможностями для возвращения дрона на базу.

### Монитор безопасности

Монитор безопасности отвечает за возможность передавать сообщение между модулями, основываясь на политиках безопасности, описанных выше. Дополнительно модуль проводит пост-происшествие проверку на корректную отработку всех задействованных в решении проблемы модулей.

## Решение

### Описание взаимодействия модулей дрона для предотвращения нарушения ЦБ 1
Нарушение ЦБ 1 является прямым следствием компроментации модуля "Управление распрыскивателем". Во избежание разбрызгивания смеси на человека предлагается разделить процесс защиты человека от смеси на два подпроцесса: отключение распрыскивателя и уворот. Таким образом, в случае компроментации модуля "Управление распрыскивателем", дрон защитит человека экстренным уворотом, так чтобы смесь, не переставая распыляться, на него не попала. В случае компроментации модуля "Управление полетом" для защиты человека применяется метод отключения распылителей. При нормальной работе дрона оба действия выполняются параллельно. Нарушение работы двух модулей сразу считается маловероятным и не рассматривается.
Таким образом, когда контроль обстановки обнаруживает человека в потенциальной зоне распыления, он передает сообщение трем модулям - "Управление полетом", "Управление распылителем", "Монитор безопасности". <br>
![Снимок экрана от 2022-12-03 12-51-24](https://user-images.githubusercontent.com/112805915/205434898-8db53096-e360-46c1-bb1d-24dc5c4274c6.png)

После факта уклонения монитором безопасности проверяется выполнение обоих условий. В случае нарушения хотя бы одного из них, дрон считается скомпроментированным и аварийно возвращается на базу при помощи доверенного модуля "Аварийное возвращение".

### Описание взаимодействия модулей дрона для предотвращения нарушения ЦБ 2
Защита нарушения от ЦБ 2 схожа с ЦБ 1. Предполагается, что обнаружение препятствия начинается на достаточном растоянии для принятия двух решений.

![Снимок экрана от 2022-12-03 12-55-43](https://user-images.githubusercontent.com/112805915/205435061-a25f76d6-4bb3-4e51-ba7f-4103f99090f5.png)


### Описание взаимодействия модулей дрона для предотвращения нарушения ЦБ 3
Защита от взлома мобильного приложения осуществляется при помощи PIN-кода.
![Снимок экрана от 2022-12-03 13-11-44](https://user-images.githubusercontent.com/112805915/205435778-e5e0479d-18a0-49dc-a16e-2f1ca7e10ea1.png)


### Описание взаимодействия модулей дрона для предотвращения нарушения ЦБ 4
Защита от подделки УЦ осуществляется при помощи ключа аутентификации.
![Снимок экрана от 2022-12-03 13-12-33](https://user-images.githubusercontent.com/112805915/205435831-f9daf379-063b-4384-923f-0f38035e7791.png)
